<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.furong.admin.mapper.PermissionMapper">

    <!-- 权限VO结果映射 -->
    <resultMap id="PermissionVoResultMap" type="com.furong.pojo.vo.PermissionVo">
        <id column="id" property="id"/>
        <result column="permission_name" property="permissionName"/>
        <result column="permission_code" property="permissionCode"/>
        <result column="description" property="description"/>
        <result column="created" property="created"/>
        <result column="updated" property="updated"/>
        <result column="role_count" property="roleCount"/>
    </resultMap>

    <!-- 获取权限列表（包含统计信息） -->
    <select id="selectPermissionList" resultMap="PermissionVoResultMap">
        SELECT 
            p.id,
            p.permission_name,
            p.permission_code,
            p.description,
            p.created,
            p.updated,
            COALESCE(rp_count.role_count, 0) as role_count
        FROM fr_permission p
        LEFT JOIN (
            SELECT 
                permission_id,
                COUNT(DISTINCT role_id) as role_count
            FROM fr_role_permission rp
            INNER JOIN fr_role r ON rp.role_id = r.id AND r.deleted = 0
            GROUP BY permission_id
        ) rp_count ON p.id = rp_count.permission_id
        WHERE p.deleted = 0
        ORDER BY p.created DESC
    </select>

    <!-- 分页查询权限列表（包含统计信息和搜索条件） -->
    <select id="selectPermissionListWithPage" resultMap="PermissionVoResultMap">
        SELECT
            p.id,
            p.permission_name,
            p.permission_code,
            p.description,
            p.created,
            p.updated,
            COALESCE(rp_count.role_count, 0) as role_count
        FROM fr_permission p
        LEFT JOIN (
            SELECT
                permission_id,
                COUNT(DISTINCT role_id) as role_count
            FROM fr_role_permission rp
            INNER JOIN fr_role r ON rp.role_id = r.id AND r.deleted = 0
            GROUP BY permission_id
        ) rp_count ON p.id = rp_count.permission_id
        WHERE p.deleted = 0
        <if test="permissionName != null and permissionName != ''">
            AND p.permission_name LIKE CONCAT('%', #{permissionName}, '%')
        </if>
        <if test="permissionCode != null and permissionCode != ''">
            AND p.permission_code LIKE CONCAT('%', #{permissionCode}, '%')
        </if>
        <if test="description != null and description != ''">
            AND p.description LIKE CONCAT('%', #{description}, '%')
        </if>
        ORDER BY p.created DESC
    </select>

    <!-- 获取权限详情 -->
    <select id="selectPermissionDetail" resultMap="PermissionVoResultMap">
        SELECT 
            p.id,
            p.permission_name,
            p.permission_code,
            p.description,
            p.created,
            p.updated,
            COALESCE(rp_count.role_count, 0) as role_count
        FROM fr_permission p
        LEFT JOIN (
            SELECT 
                permission_id,
                COUNT(DISTINCT role_id) as role_count
            FROM fr_role_permission rp
            INNER JOIN fr_role r ON rp.role_id = r.id AND r.deleted = 0
            GROUP BY permission_id
        ) rp_count ON p.id = rp_count.permission_id
        WHERE p.id = #{id} AND p.deleted = 0
    </select>

    <!-- 根据权限标识查询权限 -->
    <select id="selectByPermissionCode" resultType="com.furong.pojo.entity.Permission">
        SELECT * FROM fr_permission 
        WHERE permission_code = #{permissionCode} AND deleted = 0
    </select>

    <!-- 获取管理员的所有权限 -->
    <select id="selectAdminPermissions" resultType="com.furong.pojo.entity.Permission">
        SELECT DISTINCT p.*
        FROM fr_permission p
        INNER JOIN fr_role_permission rp ON p.id = rp.permission_id
        INNER JOIN fr_role r ON rp.role_id = r.id AND r.deleted = 0
        INNER JOIN fr_admin_role ar ON r.id = ar.role_id
        WHERE ar.admin_id = #{adminId} AND p.deleted = 0
        ORDER BY p.created DESC
    </select>

    <!-- 检查管理员是否拥有指定权限 -->
    <select id="checkAdminPermission" resultType="int">
        SELECT COUNT(DISTINCT p.id)
        FROM fr_permission p
        INNER JOIN fr_role_permission rp ON p.id = rp.permission_id
        INNER JOIN fr_role r ON rp.role_id = r.id AND r.deleted = 0
        INNER JOIN fr_admin_role ar ON r.id = ar.role_id
        WHERE ar.admin_id = #{adminId} 
          AND p.permission_code = #{permissionCode} 
          AND p.deleted = 0
    </select>

</mapper>
